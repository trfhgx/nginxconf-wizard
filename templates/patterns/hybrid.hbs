# Nginx Configuration for {{domain.primary}}
# Pattern: Hybrid (Static + Dynamic)
# Generated: {{generatedAt}}

{{#if features.upstream}}
upstream {{features.upstream.name}} {
    {{#each features.upstream.servers}}
    server {{this.host}}:{{this.port}};
    {{/each}}
    keepalive 32;
}
{{/if}}

{{#if ssl.enabled}}
server {
    listen {{domain.port}};
    listen [::]:{{domain.port}};
    server_name {{domain.primary}}{{#each domain.aliases}} {{this}}{{/each}};
    return 301 https://$server_name$request_uri;
}

server {
    listen {{domain.httpsPort}} ssl{{#if ssl.http2}} http2{{/if}};
    listen [::]:{{domain.httpsPort}} ssl{{#if ssl.http2}} http2{{/if}};
    server_name {{domain.primary}}{{#each domain.aliases}} {{this}}{{/each}};

    {{#if (eq ssl.provider "letsencrypt")}}
    ssl_certificate /etc/letsencrypt/live/{{domain.primary}}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{domain.primary}}/privkey.pem;
    {{/if}}

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers {{sslCiphers}};
{{else}}
server {
    listen {{domain.port}};
    listen [::]:{{domain.port}};
    server_name {{domain.primary}}{{#each domain.aliases}} {{this}}{{/each}};
{{/if}}

    root {{#if features.staticRoot}}{{features.staticRoot}}{{else}}/var/www/{{domain.primary}}/html{{/if}};
    index index.html;

    access_log /var/log/nginx/{{domain.primary}}/access.log combined;
    error_log /var/log/nginx/{{domain.primary}}/error.log warn;

    {{#if security.headers}}
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    {{#if ssl.enabled}}
    add_header Strict-Transport-Security "max-age=63072000" always;
    {{/if}}
    {{/if}}

    {{#each features.dynamicRoutes}}
    # Dynamic: {{this.path}}
    location {{this.path}} {
        proxy_pass {{this.target}};
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    {{/each}}

    # Static content
    location / {
        try_files $uri $uri/ =404;
        
        {{#if features.compression}}
        gzip on;
        gzip_vary on;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/javascript application/javascript application/json;
        {{/if}}
    }

    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location ~ /\. {
        deny all;
    }
}
